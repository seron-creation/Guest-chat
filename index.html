<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest Chat | Seron</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --bg: #121212; --panel: #1e1e1e; --text: #ffffff; --bubble-in: #262d31; --bubble-out: #005c4b; --header: #202c33; }
        .light-theme { --bg: #e5ddd5; --panel: #f0f2f5; --text: #111b21; --bubble-in: #ffffff; --bubble-out: #dcf8c6; --header: #ededed; }
        
        body { background: var(--bg); color: var(--text); font-family: sans-serif; transition: 0.3s; margin: 0; }
        .mobile-container { width: 100%; max-width: 450px; height: 100vh; margin: 0 auto; display: flex; flex-direction: column; background: var(--panel); position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Fixed Header Layout */
        header { p: 10px 15px; background: var(--header); display: flex; align-items: center; justify-content: space-between; min-height: 60px; border-bottom: 1px solid rgba(0,0,0,0.1); }
        
        .bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; position: relative; color: #111b21; }
        .dark-theme .bubble { color: #e9edef; }
        .bubble.me { align-self: flex-end; background: var(--bubble-out); border-top-right-radius: 2px; }
        .bubble.them { align-self: flex-start; background: var(--bubble-in); border-top-left-radius: 2px; }
        
        .img-msg { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        #file-input { display: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="dark-theme">

<div class="mobile-container">
    <div id="menu-screen" class="p-8 flex flex-col justify-center h-full">
        <h1 class="text-4xl font-black mb-2 text-center text-green-500">Guest Chat</h1>
        <p class="text-center text-gray-400 mb-8">By Seron</p>
        
        <div class="space-y-4">
            <input id="user-name" type="text" placeholder="Your Name" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 outline-none text-white">
            <button onclick="showCreateOptions()" class="w-full bg-green-600 p-4 rounded-xl font-bold">Create Room</button>
            <div id="create-options" class="hidden space-y-2 p-4 bg-gray-800 rounded-xl">
                <input id="destroy-time" type="number" placeholder="Minutes until destroy" class="w-full p-2 rounded bg-gray-700 text-white">
                <button onclick="createRoom()" class="w-full bg-green-500 p-2 rounded font-bold">Launch</button>
            </div>
            <input id="join-room-id" type="text" placeholder="Room ID" class="w-full p-4 rounded-xl bg-gray-800 border border-gray-700 outline-none text-white">
            <button onclick="joinRoom()" class="w-full bg-blue-600 p-4 rounded-xl font-bold">Join Room</button>
        </div>
        <p class="mt-auto text-center text-gray-500 text-xs">App Creator: Seron</p>
    </div>

    <div id="chat-screen" class="hidden flex flex-col h-full">
        <header>
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 rounded-full bg-green-600 flex items-center justify-center font-bold text-white">S</div>
                <div class="overflow-hidden">
                    <p id="creator-tag-top" class="text-sm font-bold truncate">Seron's Chat</p>
                    <p id="display-room-id" class="text-[9px] opacity-50 uppercase"></p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="shareRoom()" class="text-gray-400 hover:text-green-500 transition"><i class="fas fa-share-nodes text-lg"></i></button>
                <button onclick="toggleTheme()" class="text-gray-400"><i class="fas fa-circle-half-stroke text-lg"></i></button>
                <button id="admin-delete-btn" onclick="destroyRoom()" class="hidden bg-red-600 text-[10px] px-2 py-1 rounded font-bold text-white">DESTROY</button>
            </div>
        </header>

        <div id="chat-messages"></div>

        <div id="admin-upgrade-area" class="p-2 bg-black/20 flex gap-2 items-center mx-2 rounded">
            <input id="admin-verify-input" type="text" placeholder="Admin Code?" class="flex-grow bg-transparent text-xs outline-none px-2">
            <button onclick="verifyAdmin()" class="bg-yellow-600 text-[10px] px-3 py-1 rounded font-bold">Verify</button>
        </div>

        <footer class="p-3 bg-black/20 flex items-center gap-2">
            <input type="file" id="file-input" accept="image/*" onchange="uploadPhoto(this)">
            <button onclick="document.getElementById('file-input').click()" class="text-gray-400 px-2"><i class="fas fa-image text-xl"></i></button>
            <input id="msg-input" type="text" placeholder="Message..." class="flex-grow p-2 rounded-lg bg-gray-700 text-white outline-none">
            <button id="send-btn" class="bg-green-600 w-10 h-10 rounded-full flex items-center justify-center text-white"><i class="fas fa-paper-plane"></i></button>
        </footer>
    </div>
</div>

<audio id="msg-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, onChildAdded, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC4mYZ5G-WCjt7wAN0G6_B6rh1LDM10U0Q",
        authDomain: "chat-data-59467.firebaseapp.com",
        databaseURL: "https://chat-data-59467-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chat-data-59467",
        storageBucket: "chat-data-59467.firebasestorage.app",
        messagingSenderId: "237808362163",
        appId: "1:237808362163:web:52d25dfbffaffde12446c6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);

    let currentRoom = null;
    let currentUser = JSON.parse(sessionStorage.getItem('chatUser')) || { name: '', color: '', isAdmin: false };
    let roomAdminCode = "";

    // Handle Auto-Reconnect on Refresh
    window.onload = () => {
        const savedRoom = sessionStorage.getItem('currentRoom');
        if(savedRoom && currentUser.name) {
            startChat(savedRoom, currentUser.name, currentUser.isAdmin);
        }
    };

    window.toggleTheme = () => {
        document.body.classList.toggle('light-theme');
    };

    window.showCreateOptions = () => document.getElementById('create-options').classList.toggle('hidden');

    window.createRoom = async () => {
        const name = document.getElementById('user-name').value;
        if(!name) return alert("Enter name");
        const roomId = Math.random().toString(36).substring(2, 18).toUpperCase();
        const adminCode = Math.floor(1000 + Math.random() * 9000) + "AZ";
        const mins = parseInt(document.getElementById('destroy-time').value) || 30;
        
        await set(ref(db, `rooms/${roomId}`), {
            adminCode: adminCode,
            creator: "Seron",
            expiresAt: Date.now() + (mins * 60000)
        });
        
        alert(`Room ID: ${roomId}\nAdmin Code: ${adminCode}`);
        startChat(roomId, name, true);
    };

    window.joinRoom = () => {
        const name = document.getElementById('user-name').value;
        const roomId = document.getElementById('join-room-id').value.trim();
        if(name && roomId) startChat(roomId, name, false);
    };

    function startChat(roomId, name, isAdmin) {
        currentRoom = roomId;
        currentUser.name = name;
        currentUser.isAdmin = isAdmin;
        if(!currentUser.color) currentUser.color = `hsl(${Math.random() * 360}, 70%, 50%)`;
        
        // Save to session to prevent leave on refresh
        sessionStorage.setItem('currentRoom', roomId);
        sessionStorage.setItem('chatUser', JSON.stringify(currentUser));

        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('chat-screen').classList.remove('hidden');
        document.getElementById('display-room-id').innerText = roomId;

        onValue(ref(db, `rooms/${roomId}`), (snap) => {
            if(!snap.exists()) {
                sessionStorage.clear();
                location.reload();
            } else {
                roomAdminCode = snap.val().adminCode;
            }
        });

        if(currentUser.isAdmin) document.getElementById('admin-delete-btn').classList.remove('hidden');

        onChildAdded(ref(db, `messages/${roomId}`), (data) => {
            renderMessage(data.val());
            if(data.val().sender !== currentUser.name) document.getElementById('msg-sound').play().catch(()=>{});
        });
    }

    window.verifyAdmin = () => {
        if(document.getElementById('admin-verify-input').value === roomAdminCode) {
            currentUser.isAdmin = true;
            sessionStorage.setItem('chatUser', JSON.stringify(currentUser));
            document.getElementById('admin-delete-btn').classList.remove('hidden');
            document.getElementById('admin-upgrade-area').classList.add('hidden');
        }
    };

    window.shareRoom = () => {
        const url = `${window.location.origin}${window.location.pathname}?room=${currentRoom}`;
        if(navigator.share) {
            navigator.share({ title: 'Join My Chat', url: url });
        } else {
            prompt("Copy room link:", url);
        }
    };

    window.uploadPhoto = async (input) => {
        if(!input.files[0]) return;
        const fileRef = sRef(storage, `uploads/${Date.now()}`);
        const snap = await uploadBytes(fileRef, input.files[0]);
        const url = await getDownloadURL(snap.ref);
        push(ref(db, `messages/${currentRoom}`), {
            sender: currentUser.name, color: currentUser.color, image: url, timestamp: Date.now()
        });
    };

    document.getElementById('send-btn').onclick = () => {
        const val = document.getElementById('msg-input').value;
        if(!val) return;
        push(ref(db, `messages/${currentRoom}`), {
            sender: currentUser.name, color: currentUser.color, text: val, timestamp: Date.now()
        });
        document.getElementById('msg-input').value = "";
    };

    function renderMessage(msg) {
        const div = document.createElement('div');
        div.className = `bubble ${msg.sender === currentUser.name ? 'me' : 'them'}`;
        div.innerHTML = `<b style="color:${msg.color};font-size:10px">${msg.sender}</b><br>` + 
                        (msg.image ? `<img src="${msg.image}" class="img-msg">` : `<span>${msg.text}</span>`);
        document.getElementById('chat-messages').appendChild(div);
        document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
    }

    window.destroyRoom = () => {
        if(confirm("Destroy room for everyone?")) {
            remove(ref(db, `rooms/${currentRoom}`));
            remove(ref(db, `messages/${currentRoom}`));
        }
    };
</script>
</body>
</html>
