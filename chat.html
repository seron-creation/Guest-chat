<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zero Chat - Private Room</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --bg: #0b141a; --header: #202c33; --input: #2a3942; --text: #e9edef; }
        body { background: var(--bg); color: var(--text); height: 100dvh; margin: 0; overflow: hidden; display: flex; justify-content: center; font-family: sans-serif; }
        .app-container { width: 100%; max-width: 450px; height: 100%; display: flex; flex-direction: column; position: relative; border-left: 1px solid #222; border-right: 1px solid #222; }
        #chatBox { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: var(--bg); }
        .bubble { align-self: flex-end; background: #005c4b; padding: 10px 14px; border-radius: 14px 14px 2px 14px; max-width: 85%; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 15px; animation: pop 0.2s ease-out; }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .admin-tag { background: #ca8a04; color: white; font-size: 8px; padding: 2px 6px; border-radius: 4px; font-weight: 900; margin-left: 8px; }
        footer { background: var(--header); padding: 14px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #333; }
        #msgInput { flex: 1; background: var(--input); border: none; padding: 12px 20px; border-radius: 25px; color: white; outline: none; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="app-container">
    <header class="p-4 bg-[var(--header)] flex justify-between items-center shadow-2xl z-10">
        <div class="flex flex-col">
            <div class="flex items-center">
                <h2 id="userName" class="font-black text-emerald-400 text-lg italic tracking-tighter">ZERO</h2>
                <span id="adminBadge" class="admin-tag hidden">ADMIN</span>
            </div>
            <p id="roomID" class="text-[9px] opacity-50 uppercase font-bold tracking-[0.1em]">Room: Checking...</p>
        </div>
        <div class="flex gap-2">
            <button id="btnReqAdmin" class="text-[9px] bg-white/5 border border-white/10 px-2 py-1.5 rounded-lg hover:bg-emerald-600 transition">REQUEST ADMIN</button>
            <button id="btnLeave" class="text-[10px] bg-red-600 text-white px-3 py-1.5 rounded-lg font-black shadow-lg">LEAVE</button>
        </div>
    </header>

    <div id="chatBox"></div>

    <footer>
        <input id="msgInput" type="text" placeholder="Send private message...">
        <button id="btnSend" class="bg-[#00a884] w-12 h-12 rounded-full flex items-center justify-center shadow-xl hover:scale-105 transition">âž¤</button>
    </footer>
    
    <button id="btnDestroy" class="hidden w-full bg-red-900 text-white text-[10px] py-2 font-black uppercase tracking-widest">Wipe Room History</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, set, push, onChildAdded, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC4mYZ5G-WCjt7wAN0G6_B6rh1LDM10U0Q",
        authDomain: "chat-data-59467.firebaseapp.com",
        databaseURL: "https://chat-data-59467-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "chat-data-59467",
        storageBucket: "chat-data-59467.firebasestorage.app",
        messagingSenderId: "237808362163",
        appId: "1:237808362163:web:52d25dfbffaffde12446c6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // Get room name from URL (?room=testing) or use 'lobby'
    let currentRoom = new URLSearchParams(window.location.search).get('room') || 'lobby';
    let isAdmin = false;

    // --- SYSTEM PERMISSIONS ---
    if (Notification.permission !== "granted") Notification.requestPermission();

    // --- REFRESH PROTECTION ---
    window.addEventListener('beforeunload', (e) => {
        e.preventDefault();
        e.returnValue = 'Unsaved data will be lost. Use LEAVE button to logout.'; 
    });

    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "index.html";
        else {
            document.getElementById('userName').innerText = user.email.split('@')[0].toUpperCase();
            document.getElementById('roomID').innerText = `NODE: ${currentRoom}`;
            initChat(user.uid);
        }
    });

    function initChat(uid) {
        const roomRef = ref(db, `rooms/${currentRoom}`);
        const messagesRef = ref(db, `rooms/${currentRoom}/messages`);

        // Check/Create Room with Random Admin Code
        onValue(roomRef, (snap) => {
            if (!snap.exists()) {
                const randomCode = "Z-" + Math.random().toString(36).substring(2, 7).toUpperCase();
                set(roomRef, { 
                    createdBy: uid, 
                    adminCode: randomCode, 
                    createdAt: Date.now() 
                });
                alert("NEW SECURE NODE CREATED!\nRANDOM ADMIN CODE: " + randomCode + "\nWrite this down. It will not be shown again.");
            }
        }, { onlyOnce: true });

        // Real-time message listener
        onChildAdded(messagesRef, (snap) => {
            const msg = snap.val();
            renderMessage(msg);

            // Notify & Vibrate if not active
            if (document.hidden) {
                if (Notification.permission === "granted") new Notification("ZERO Network", { body: msg.text });
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            }
        });

        // Request Admin Code Check
        document.getElementById('btnReqAdmin').onclick = () => {
            const input = prompt("Enter the Secret Admin Code for this Room:");
            onValue(roomRef, (snap) => {
                if (snap.exists() && input === snap.val().adminCode) {
                    isAdmin = true;
                    document.getElementById('adminBadge').classList.remove('hidden');
                    document.getElementById('btnDestroy').classList.remove('hidden');
                    document.getElementById('btnReqAdmin').classList.add('hidden');
                    alert("Admin clearance granted.");
                } else {
                    alert("Unauthorized Access.");
                }
            }, { onlyOnce: true });
        };

        // Send Logic
        document.getElementById('btnSend').onclick = () => {
            const text = msgInput.value.trim();
            if (text) {
                push(messagesRef, { text, time: Date.now(), sender: uid });
                msgInput.value = "";
            }
        };

        // Force Leave
        document.getElementById('btnLeave').onclick = () => {
            if (confirm("Disconnect from Zero Node?")) {
                signOut(auth).then(() => window.location.href = "index.html");
            }
        };

        // Destroy History
        document.getElementById('btnDestroy').onclick = () => {
            if (confirm("WIPE ENTIRE ROOM HISTORY?")) {
                remove(messagesRef);
                location.reload();
            }
        };
    }

    function renderMessage(msg) {
        const chatBox = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = "bubble";
        div.innerHTML = `<div>${msg.text}</div><div class="text-[8px] text-right opacity-40 mt-1 font-bold">${new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>
